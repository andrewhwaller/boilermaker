# frozen_string_literal: true

require "test_helper"

class Admin::AuditLogsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @admin = users(:admin)
    @regular_user = users(:verified)

    # Create some audit logs for testing
    Current.user = @admin
    Current.ip_address = "127.0.0.1"
    AuditLog.log(user: @admin, action: :create, auditable: @regular_user, changes: {})
    AuditLog.log(user: @admin, action: :update, auditable: @regular_user, changes: { verified: [false, true] })
    Current.reset
  end

  # ============================================================================
  # INDEX
  # ============================================================================

  test "admin can view audit logs index" do
    sign_in(@admin)

    get admin_audit_logs_path

    assert_response :success
  end

  test "regular user cannot view audit logs" do
    sign_in(@regular_user)

    get admin_audit_logs_path

    assert_redirected_to root_path
    assert_match(/access denied/i, flash[:alert])
  end

  test "unauthenticated user cannot view audit logs" do
    get admin_audit_logs_path

    assert_redirected_to sign_in_path
  end

  # ============================================================================
  # FILTERS
  # ============================================================================

  test "filters by model type" do
    sign_in(@admin)

    get admin_audit_logs_path(type: "User")

    assert_response :success
  end

  test "filters by action" do
    sign_in(@admin)

    get admin_audit_logs_path(action_type: "create")

    assert_response :success
  end

  test "filters by date range" do
    sign_in(@admin)

    get admin_audit_logs_path(
      start_date: 7.days.ago.to_date.to_s,
      end_date: Date.current.to_s
    )

    assert_response :success
  end

  # ============================================================================
  # SHOW
  # ============================================================================

  test "admin can view audit log details" do
    sign_in(@admin)
    audit_log = AuditLog.last

    get admin_audit_log_path(audit_log)

    assert_response :success
  end

  # ============================================================================
  # EXPORT
  # ============================================================================

  test "admin can export audit logs as CSV" do
    sign_in(@admin)

    get export_admin_audit_logs_path(format: :csv)

    assert_response :success
    assert_equal "text/csv", response.content_type.split(";").first
    assert_includes response.headers["Content-Disposition"], "audit_logs"
  end

  # ============================================================================
  # HELPERS
  # ============================================================================

  private

  def sign_in(user)
    session = user.sessions.create!(
      user_agent: "Test Agent",
      ip_address: "127.0.0.1"
    )
    cookies[:session_token] = session.id
  end
end
