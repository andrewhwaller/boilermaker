# frozen_string_literal: true

require "test_helper"

class PaymentsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @user = users(:verified)
  end

  # ============================================================================
  # PRICING PAGE
  # ============================================================================

  test "shows pricing page without authentication" do
    get pricing_path

    assert_response :success
  end

  test "shows pricing page with authentication" do
    sign_in(@user)

    get pricing_path

    assert_response :success
  end

  # ============================================================================
  # CHECKOUT
  # ============================================================================

  test "checkout requires authentication" do
    post checkout_path("starter")

    assert_redirected_to sign_in_path
  end

  test "checkout with invalid plan redirects to pricing" do
    sign_in(@user)

    post checkout_path("nonexistent_plan")

    assert_redirected_to pricing_path
    assert_match(/invalid plan/i, flash[:alert])
  end

  # Note: Full checkout testing requires Stripe test mode credentials
  # and is better suited for system tests with Stripe's test card numbers

  # ============================================================================
  # SUCCESS/CANCEL
  # ============================================================================

  test "success page redirects to billing with notice" do
    sign_in(@user)

    get payment_success_path

    assert_redirected_to settings_billing_path
    assert_match(/thank you/i, flash[:notice])
  end

  test "cancel page redirects to pricing" do
    sign_in(@user)

    get payment_cancel_path

    assert_redirected_to pricing_path
    assert_match(/cancelled/i, flash[:notice])
  end

  # ============================================================================
  # PORTAL
  # ============================================================================

  test "portal requires authentication" do
    post billing_portal_path

    assert_redirected_to sign_in_path
  end

  # Note: Full portal testing requires Stripe test mode credentials

  # ============================================================================
  # HELPERS
  # ============================================================================

  private

  def sign_in(user)
    session = user.sessions.create!(
      user_agent: "Test Agent",
      ip_address: "127.0.0.1"
    )
    cookies[:session_token] = session.id
  end
end
