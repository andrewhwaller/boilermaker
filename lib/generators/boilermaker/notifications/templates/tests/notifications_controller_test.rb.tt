# frozen_string_literal: true

require "test_helper"

class NotificationsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @user = users(:verified)
    sign_in(@user)
  end

  # ============================================================================
  # INDEX
  # ============================================================================

  test "shows notifications index" do
    create_test_notification(@user)

    get notifications_path

    assert_response :success
  end

  test "shows empty state when no notifications" do
    get notifications_path

    assert_response :success
    assert_select "p", /no notifications/i
  end

  # ============================================================================
  # MARK READ
  # ============================================================================

  test "marks single notification as read" do
    notification = create_test_notification(@user)
    assert_nil notification.read_at

    post mark_read_notification_path(notification)

    notification.reload
    assert_not_nil notification.read_at
  end

  # ============================================================================
  # MARK ALL READ
  # ============================================================================

  test "marks all notifications as read" do
    3.times { create_test_notification(@user) }
    assert_equal 3, @user.unread_notifications_count

    post mark_all_read_notifications_path

    assert_redirected_to notifications_path
    assert_equal 0, @user.reload.unread_notifications_count
  end

  # ============================================================================
  # AUTHORIZATION
  # ============================================================================

  test "requires authentication" do
    sign_out

    get notifications_path

    assert_redirected_to sign_in_path
  end

  test "cannot see other user notifications" do
    other_user = users(:admin)
    notification = create_test_notification(other_user)

    assert_raises(ActiveRecord::RecordNotFound) do
      post mark_read_notification_path(notification)
    end
  end

  # ============================================================================
  # HELPERS
  # ============================================================================

  private

  def sign_in(user)
    session = user.sessions.create!(
      user_agent: "Test Agent",
      ip_address: "127.0.0.1"
    )
    cookies[:session_token] = session.id
  end

  def sign_out
    cookies.delete(:session_token)
  end

  def create_test_notification(recipient)
    # Create a notification event and delivery record
    event = Noticed::Event.create!(
      type: "WelcomeNotifier",
      params: { message: "Test notification" }
    )

    Noticed::Notification.create!(
      event: event,
      recipient: recipient,
      type: "Noticed::Notification"
    )
  end
end
