<%# Boilermaker engine layout: terminal theme %>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BOILERMAKER TERMINAL</title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    /*
     * TERMINAL THEME - Standalone version for Boilermaker config UI
     * Keep in sync with: app/assets/tailwind/themes.css (Terminal dark polarity)
     *
     * This is intentionally self-contained so the engine works independently.
     * Variable names match the main theme system for consistency.
     */
    :root {
      /* Core theme variables - match themes.css Terminal dark */
      --bg: #0a0a0a;
      --bg-alt: #111110;
      --bg-inverse: #33ff33;
      --text: #33ff33;
      --text-muted: #1a8c1a;
      --accent: #ffb000;
      --accent-muted: #805800;
      --border: #1a8c1a;
      --border-light: #143614;
      /* Config-specific extras */
      --glow: rgba(51, 255, 51, 0.15);
      --font-mono: 'IBM Plex Mono', monospace;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-mono);
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* CRT effect overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.15),
          rgba(0, 0, 0, 0.15) 1px,
          transparent 1px,
          transparent 2px
        );
      pointer-events: none;
      z-index: 1000;
    }

    /* Subtle vignette */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(ellipse at center, transparent 0%, rgba(0,0,0,0.3) 100%);
      pointer-events: none;
      z-index: 999;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      padding-bottom: 100px;
      position: relative;
    }

    /* Header */
    .header {
      border-bottom: 1px solid var(--text-muted);
      padding-bottom: 16px;
      margin-bottom: 24px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 12px;
      letter-spacing: 0.15em;
    }

    .logo-main {
      color: var(--text);
    }

    .system-info {
      font-size: 11px;
      color: var(--text-muted);
    }

    .nav {
      display: flex;
      gap: 24px;
      margin-top: 12px;
      font-size: 12px;
    }

    .nav a {
      color: var(--text-muted);
      text-decoration: none;
    }

    .nav a:hover,
    .nav a.active {
      color: var(--text);
    }

    .nav a.active::before {
      content: '> ';
    }

    /* Flash messages */
    .flash-messages {
      margin-bottom: 24px;
    }

    .flash {
      padding: 8px 12px;
      border: 1px solid var(--text-muted);
      margin-bottom: 8px;
      font-size: 12px;
    }

    .flash::before {
      content: '> ';
      color: var(--text);
    }

    .flash.notice {
      border-color: var(--text);
      color: var(--text);
    }

    .flash.alert {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Footer info */
    .footer-info {
      position: fixed;
      bottom: 50px;
      left: 24px;
      right: 24px;
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--text-muted);
    }

    .status-ok::before {
      content: '● ';
      color: var(--text);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-alt);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-muted);
    }

    /* Selection */
    ::selection {
      background: var(--text);
      color: var(--bg);
    }
  </style>

  <script type="module">
    import { Application, Controller } from "<%= asset_path "stimulus.min.js" %>"

    class ServerStatusController extends Controller {
      static targets = ["submitButton", "message"]
      static values = { restartUrl: String }

      connect() {
        const form = document.getElementById('settings_form')
        if (form) {
          form.addEventListener('submit', this.handleSubmit.bind(this))
        }
      }

      handleSubmit(event) {
        if (this.hasSubmitButtonTarget) {
          this.submitButtonTarget.disabled = true
          this.submitButtonTarget.textContent = 'SAVING...'
        }
        if (this.hasMessageTarget) {
          this.messageTarget.textContent = 'SAVING CONFIGURATION AND RESTARTING SERVER...'
        }
        setTimeout(() => this.startRestartMonitoring(), 1000)
      }

      startRestartMonitoring() {
        if (this.hasMessageTarget) {
          this.messageTarget.innerHTML = '<span style="animation: blink 1s step-end infinite">▌</span> SERVER IS RESTARTING... PLEASE WAIT.'
        }
        this.pollInterval = setInterval(() => this.checkServerHealth(), 2000)
        this.pollTimeout = setTimeout(() => this.stopMonitoring(false), 30000)
      }

      async checkServerHealth() {
        try {
          const response = await fetch(this.restartUrlValue, { method: 'GET', cache: 'no-cache' })
          if (response.ok) {
            this.stopMonitoring(true)
          }
        } catch (error) {}
      }

      stopMonitoring(success) {
        if (this.pollInterval) {
          clearInterval(this.pollInterval)
          this.pollInterval = null
        }
        if (this.pollTimeout) {
          clearTimeout(this.pollTimeout)
          this.pollTimeout = null
        }
        if (this.hasMessageTarget) {
          if (success) {
            this.messageTarget.innerHTML = '● SERVER RESTARTED SUCCESSFULLY. YOU MAY RETURN TO THE APP.'
            this.messageTarget.style.color = 'var(--text)'  /* success: green */
            if (this.hasSubmitButtonTarget) {
              this.submitButtonTarget.disabled = false
              this.submitButtonTarget.textContent = 'SAVE CHANGES'
            }
          } else {
            this.messageTarget.innerHTML = '○ SERVER IS TAKING LONGER THAN EXPECTED. PLEASE REFRESH MANUALLY.'
            this.messageTarget.style.color = 'var(--accent)'
            if (this.hasSubmitButtonTarget) {
              this.submitButtonTarget.disabled = false
              this.submitButtonTarget.textContent = 'SAVE CHANGES'
            }
          }
        }
      }

      disconnect() {
        this.stopMonitoring(false)
      }
    }

    class ClockController extends Controller {
      connect() {
        this.tick()
        this.timer = setInterval(() => this.tick(), 1000)
      }

      disconnect() {
        clearInterval(this.timer)
      }

      tick() {
        const now = new Date()
        const options = { hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false, timeZone: "UTC" }
        const formatted = now.toLocaleTimeString("en-GB", options)
        this.element.textContent = `${formatted} UTC`
      }
    }

    const application = Application.start()
    application.register("server-status", ServerStatusController)
    application.register("clock", ClockController)
  </script>

  <style>
    @keyframes blink {
      50% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-row">
        <div class="logo">
          <span class="logo-main">BOILERMAKER</span>
          <span class="system-info"> v<%= Boilermaker::VERSION %> // SYSTEM CONFIGURATION</span>
        </div>
        <div class="system-info">
          <span data-controller="clock"><%= Time.current.strftime("%H:%M:%S UTC") %></span>
        </div>
      </div>
      <nav class="nav">
        <a href="<%= boilermaker.edit_settings_path %>" class="active">settings</a>
        <a href="<%= main_app.root_path %>">app</a>
      </nav>
    </header>

    <% unless flash.empty? %>
      <div class="flash-messages">
        <% flash.each do |type, message| %>
          <div class="flash <%= type %>"><%= message %></div>
        <% end %>
      </div>
    <% end %>

    <%= yield %>
  </div>

  <div class="footer-info">
    <span class="status-ok">RAILS <%= Rails.version %> | RUBY <%= RUBY_VERSION %></span>
    <span>ENV: <%= Rails.env.upcase %> | THEME: <%= Boilermaker::Config.theme_name.upcase %></span>
  </div>
</body>
</html>
