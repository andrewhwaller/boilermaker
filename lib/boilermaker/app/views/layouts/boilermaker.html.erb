<%# Boilermaker engine layout: independent styling with terminal theme %>
<!DOCTYPE html>
<html lang="en" data-theme="terminal">
 <head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>Boilermaker Settings</title>
 <%= csrf_meta_tags %>
 <%= csp_meta_tag %>

 <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>

 <script type="module">
   import { Application, Controller } from "<%= asset_path "stimulus.min.js" %>"

   class ServerStatusController extends Controller {
     static targets = ["submitButton", "message"]
     static values = { restartUrl: String }

     connect() {
       const form = document.getElementById('settings_form')
       if (form) {
         form.addEventListener('submit', this.handleSubmit.bind(this))
       }
     }

     handleSubmit(event) {
       if (this.hasSubmitButtonTarget) {
         this.submitButtonTarget.disabled = true
         this.submitButtonTarget.textContent = 'Saving...'
       }
       if (this.hasMessageTarget) {
         this.messageTarget.textContent = 'Saving configuration and restarting server...'
       }
       setTimeout(() => this.startRestartMonitoring(), 1000)
     }

     startRestartMonitoring() {
       if (this.hasMessageTarget) {
         this.messageTarget.innerHTML = '<span class="inline-flex items-center gap-2"><span class="loading loading-spinner loading-xs"></span> Server is restarting... Please wait.</span>'
       }
       this.pollInterval = setInterval(() => this.checkServerHealth(), 2000)
       this.pollTimeout = setTimeout(() => this.stopMonitoring(false), 30000)
     }

     async checkServerHealth() {
       try {
         const response = await fetch(this.restartUrlValue, { method: 'GET', cache: 'no-cache' })
         if (response.ok) {
           this.stopMonitoring(true)
         }
       } catch (error) {}
     }

     stopMonitoring(success) {
       if (this.pollInterval) {
         clearInterval(this.pollInterval)
         this.pollInterval = null
       }
       if (this.pollTimeout) {
         clearTimeout(this.pollTimeout)
         this.pollTimeout = null
       }
       if (this.hasMessageTarget) {
         if (success) {
           this.messageTarget.innerHTML = '<span class="text-success font-medium">âœ“ Server restarted successfully! You can now return to the app.</span>'
           if (this.hasSubmitButtonTarget) {
             this.submitButtonTarget.disabled = false
             this.submitButtonTarget.textContent = 'Save Changes'
           }
         } else {
           this.messageTarget.innerHTML = '<span class="text-warning">Server is taking longer than expected to restart. Please refresh the page manually.</span>'
           if (this.hasSubmitButtonTarget) {
             this.submitButtonTarget.disabled = false
             this.submitButtonTarget.textContent = 'Save Changes'
           }
         }
       }
     }

     disconnect() {
       this.stopMonitoring(false)
     }
   }

   class ClockController extends Controller {
     static values = { format: { type: String, default: "%H:%M:%S UTC" }, interval: { type: Number, default: 1000 } }

     connect() {
       this.tick()
       this.timer = setInterval(() => this.tick(), this.intervalValue)
     }

     disconnect() {
       clearInterval(this.timer)
     }

     tick() {
       const now = new Date()
       const options = { hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false, timeZone: "UTC" }
       const formatted = now.toLocaleTimeString("en-GB", options)
       this.element.textContent = `${formatted} UTC`
     }
   }

   const application = Application.start()
   application.register("server-status", ServerStatusController)
   application.register("clock", ClockController)
 </script>

 <style>
   :root {
     --app-font-family: "CommitMonoIndustrial", monospace;
     --app-text-transform: uppercase;
     --app-font-scale: 1.12;
   }
 </style>
 </head>
 <body class="min-h-screen bg-base-100 text-base-content">
 <!-- TOP HEADER -->
 <header class="border-b border-base-300 bg-base-200">
 <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
 <div class="flex items-center gap-4">
 <div class="text-sm text-base-content/70 font-semibold uppercase">BOILERMAKER SETTINGS</div>
 </div>
 <div class="flex items-center gap-4">
 <span class="text-xs text-base-content/50">SYSTEM TIME: <span data-controller="clock" data-clock-format-value="%H:%M:%S UTC"><%= Time.current.strftime("%H:%M:%S UTC") %></span></span>
 </div>
 </div>
 </header>

 <!-- SYSTEM MESSAGES -->
 <% unless flash.empty? %>
 <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4 space-y-2">
        <% flash.each do |type, message| %>
          <% status_config = case type.to_sym
          when :notice, :success
            { color: 'success', bg: 'bg-success/10', border: 'border-success/30', text: 'text-success' }
          when :alert, :error
            { color: 'error', bg: 'bg-error/10', border: 'border-error/30', text: 'text-error' }
          else
            { color: 'info', bg: 'bg-info/10', border: 'border-info/30', text: 'text-info' }
          end %>
 <div class="<%= status_config[:bg] %> border <%= status_config[:border] %> p-3">
 <div class="flex items-center gap-2">
 <div class="w-1.5 h-1.5 bg-<%= status_config[:color] %> rounded-full"></div>
 <span class="text-base-content text-sm"><%= message %></span>
 </div>
 </div>
 <% end %>
 </div>
 <% end %>

 <!-- MAIN CONTROL INTERFACE -->
 <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
 <div class="grid grid-cols-1 gap-6">
 <%= yield %>
 </div>
  <!-- SYSTEM STATUS BAR -->
 <div class="mt-8 border-t border-primary/30 pt-4">
 </div>
 </main>
 </body>
</html>
